name: coverage

on:
  push:
    branches: [ master, main ]
  pull_request:

permissions:
  contents: read
  id-token: write

jobs:
  coverage:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        compiler: [gcc, clang]

    env:
      BUILD_DIR: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install toolchain & coverage deps
        run: |
          sudo apt-get update
          if [ "${{ matrix.compiler }}" = "gcc" ]; then
            sudo apt-get install -y gcc g++ lcov
          else
            # ubuntu-24.04: get clang/llvm, and lcov for post-filtering
            sudo apt-get install -y clang llvm lcov
          fi

      - name: Configure (${{ matrix.compiler }})
        run: |
          if [ "${{ matrix.compiler }}" = "gcc" ]; then
            cmake -S . -B "$BUILD_DIR" \
              -DCMAKE_BUILD_TYPE=Debug \
              -DSINTRA_ENABLE_COVERAGE=ON \
              -DSINTRA_BUILD_TESTS=ON \
              -DSINTRA_BUILD_EXAMPLES=OFF
          else
            cmake -S . -B "$BUILD_DIR" \
              -DCMAKE_BUILD_TYPE=Debug \
              -DSINTRA_ENABLE_COVERAGE=ON \
              -DSINTRA_BUILD_TESTS=ON \
              -DSINTRA_BUILD_EXAMPLES=OFF \
              -DCMAKE_C_COMPILER=clang \
              -DCMAKE_CXX_COMPILER=clang++
          fi

      - name: Compute build parallelism
        shell: bash
        run: |
          set -euo pipefail
          if command -v nproc >/dev/null 2>&1; then
            total=$(nproc)
          else
            total=$(getconf _NPROCESSORS_ONLN || echo 2)
          fi
          if [ -z "$total" ] || [ "$total" -lt 1 ]; then
            total=2
          fi
          jobs=$(( total - 2 ))
          if [ "$jobs" -lt 2 ]; then
            jobs=2
          fi
          if [ "$jobs" -gt "$total" ]; then
            jobs="$total"
          fi
          echo "BUILD_JOBS=$jobs" >> "$GITHUB_ENV"
          echo "Using $jobs build jobs (detected $total cores)."

      - name: Build
        run: cmake --build "$BUILD_DIR" --parallel ${{ env.BUILD_JOBS }}

      - name: Run tests
        working-directory: tests
        run: |
          # Continue even on test failure to collect coverage data
          python3 run_tests.py --timeout 120 --build-dir ../${{ env.BUILD_DIR }} --config Debug || true

      # GCC: capture executed lines, then keep only library headers
      - name: Coverage (lcov/gcc)
        if: matrix.compiler == 'gcc'
        working-directory: ${{ env.BUILD_DIR }}
        run: |
          # Use --ignore-errors negative for multi-threaded test race conditions
          lcov --quiet --capture --directory . --ignore-errors negative -o lcov.all.info
          lcov --quiet --extract lcov.all.info "*/include/sintra/*" --ignore-errors negative -o lcov.info
          lcov --list lcov.info || true

      # Clang: capture gcov-compatible data with llvm-cov gcov, then filter to sintra headers
      - name: Coverage (lcov/clang)
        if: matrix.compiler == 'clang'
        working-directory: ${{ env.BUILD_DIR }}
        run: |
          # Find llvm-cov (may be versioned on Ubuntu)
          GCOV_TOOL=$(command -v llvm-cov || command -v llvm-cov-18 || command -v llvm-cov-17)
          if [ -z "$GCOV_TOOL" ]; then
            echo "llvm-cov not found"
            exit 1
          fi

          cat > llvm-cov-gcov <<EOF
          #!/usr/bin/env bash
          exec "$GCOV_TOOL" gcov "\$@"
          EOF
          chmod +x llvm-cov-gcov

          lcov --quiet --capture --directory . --ignore-errors negative,inconsistent \
            --gcov-tool "$(pwd)/llvm-cov-gcov" -o lcov.all.info
          lcov --quiet --extract lcov.all.info "*/include/sintra/*" --ignore-errors negative,inconsistent -o lcov.info
          lcov --list lcov.info || true

      - name: Summarize coverage (lcov)
        if: always()
        working-directory: ${{ env.BUILD_DIR }}
        shell: bash
        run: |
          if [ ! -f lcov.info ]; then
            echo "No lcov.info found; skipping summary."
            exit 0
          fi

          LF=$(grep -h "^LF:" lcov.info | awk -F: '{s+=$2} END{print s+0}')
          LH=$(grep -h "^LH:" lcov.info | awk -F: '{s+=$2} END{print s+0}')
          if [ "$LF" -gt 0 ]; then
            PCT=$(awk -v lh="$LH" -v lf="$LF" 'BEGIN { printf "%.2f", (lh/lf*100.0) }')
          else
            PCT="0.00"
          fi

          echo "Line coverage: $LH / $LF ($PCT%)"
          {
            echo "### ${{ matrix.compiler }} coverage"
            echo ""
            echo "Line coverage: **$LH / $LF ($PCT%)**"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload coverage to Codecov
        if: always()
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: build/lcov.info
          disable_search: true
          flags: ${{ matrix.compiler }}
          fail_ci_if_error: false

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.compiler }}-coverage
          path: build/lcov.info
