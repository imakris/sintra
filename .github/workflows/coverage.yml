name: coverage

on:
  push:
    branches: [ master, main ]
  pull_request:

permissions:
  contents: read
  id-token: write

jobs:
  coverage:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        compiler: [gcc, clang]

    env:
      BUILD_DIR: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install toolchain & coverage deps
        run: |
          sudo apt-get update
          if [ "${{ matrix.compiler }}" = "gcc" ]; then
            sudo apt-get install -y gcc g++ lcov
          else
            # ubuntu-24.04: get clang/llvm, and lcov for post-filtering
            sudo apt-get install -y clang llvm lcov
          fi

      - name: Configure (${{ matrix.compiler }})
        run: |
          if [ "${{ matrix.compiler }}" = "gcc" ]; then
            cmake -S . -B "$BUILD_DIR" \
              -DCMAKE_BUILD_TYPE=Debug \
              -DSINTRA_ENABLE_COVERAGE=ON \
              -DSINTRA_BUILD_TESTS=ON \
              -DSINTRA_BUILD_EXAMPLES=OFF
          else
            cmake -S . -B "$BUILD_DIR" \
              -DCMAKE_BUILD_TYPE=Debug \
              -DSINTRA_ENABLE_COVERAGE=ON \
              -DSINTRA_BUILD_TESTS=ON \
              -DSINTRA_BUILD_EXAMPLES=OFF \
              -DCMAKE_C_COMPILER=clang \
              -DCMAKE_CXX_COMPILER=clang++
          fi

      - name: Build
        run: cmake --build "$BUILD_DIR" -j2

      - name: Run tests
        working-directory: tests
        run: |
          if [ "${{ matrix.compiler }}" = "clang" ]; then
            export LLVM_PROFILE_FILE="${{ github.workspace }}/${{ env.BUILD_DIR }}/code-%p-%m.profraw"
          fi
          # Continue even on test failure to collect coverage data
          python3 run_tests.py --timeout 120 --build-dir ../${{ env.BUILD_DIR }} --config Debug || true

      # GCC: strict capture (includes unexecuted lines/files), then keep only library headers
      - name: Coverage (lcov/gcc)
        if: matrix.compiler == 'gcc'
        working-directory: ${{ env.BUILD_DIR }}
        run: |
          lcov --quiet --capture --initial --directory . --rc geninfo_unexecuted_blocks=1 -o base.info
          lcov --quiet --capture --directory . --rc geninfo_unexecuted_blocks=1 -o test.info
          lcov --quiet -a base.info -a test.info -o lcov.all.info
          lcov --quiet --extract lcov.all.info "*/include/sintra/*" -o lcov.info
          lcov --list lcov.info || true

      # Clang/LLVM: export to LCOV, then filter to sintra headers
      - name: Coverage (llvm-cov/clang)
        if: matrix.compiler == 'clang'
        working-directory: ${{ env.BUILD_DIR }}
        run: |
          # Find llvm tools (may be versioned on Ubuntu)
          PROFDATA=$(command -v llvm-profdata || command -v llvm-profdata-18 || command -v llvm-profdata-17)
          COV=$(command -v llvm-cov || command -v llvm-cov-18 || command -v llvm-cov-17)

          # Merge all profile data files
          $PROFDATA merge -sparse *.profraw -o default.profdata

          # Find a test binary (debug configuration)
          TEST_BIN=$(find . -maxdepth 1 -name "sintra_*_debug" -type f -executable | head -1)
          if [ -z "$TEST_BIN" ]; then
            echo "No test binaries found"
            ls -la
            exit 1
          fi

          # Use the first test binary as the primary object for coverage export
          # All binaries share the same instrumented source files
          $COV export -format=lcov -instr-profile default.profdata "$TEST_BIN" > lcov.all.info
          lcov --quiet --extract lcov.all.info "*/include/sintra/*" -o lcov.info
          $COV report -instr-profile default.profdata "$TEST_BIN" || true

      - name: Upload coverage to Codecov
        if: always()
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: build/lcov.info
          disable_search: true
          flags: ${{ matrix.compiler }}
          fail_ci_if_error: false

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.compiler }}-coverage
          path: build/lcov.info
